name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Run tests
      run: |
        chmod +x tests/test_site.sh
        ./tests/test_site.sh

    - name: Debug Docker Hub credentials
      run: |
        echo "=== DEBUG SECRETS ==="
        echo "DOCKERHUB_USERNAME exists: ${{ secrets.DOCKERHUB_USERNAME != '' }}"
        echo "DOCKERHUB_TOKEN exists: ${{ secrets.DOCKERHUB_TOKEN != '' }}"
        echo "Username first chars: ${{ secrets.DOCKERHUB_USERNAME }}"
        echo "Token first chars: ${{ secrets.DOCKERHUB_TOKEN }}"
        echo "====================="

    - name: Login to Docker Hub
      run: |
        echo "Logging into Docker Hub..."
        echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
        echo "Login completed!"

    - name: Build Docker image
      run: |
        echo "Building Docker image..."
        docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/final-project:latest .
        echo "Build successful!"

    - name: Push Docker image
      run: |
        echo "Pushing to Docker Hub..."
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/final-project:latest
        echo "Push successful!"

    - name: Deploy confirmation
      run: |
        echo "âœ… CI/CD Pipeline COMPLETED SUCCESSFULLY!"
        echo "Image: ${{ secrets.DOCKERHUB_USERNAME }}/final-project:latest"